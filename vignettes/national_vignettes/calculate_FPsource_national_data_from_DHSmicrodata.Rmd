---
title: "Calculating family planning source proportions from DHS survey microdata"
author: "Hannah Comiskey"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Introduction

This vignette is an example of how I calculate family planning (FP) source aggregated observations from DHS microdata. Default data is included in this package in the /data folder. However, you can use this vignette to calculate FP source data for additional countries if required. This process would not have been possible without the help of Kristin Bietsch, PhD, Avenir Health. 

## National level data

To begin, you will need to register for access to the DHS program data. Further details on how to do this can be found on their website: https://dhsprogram.com/data/new-user-registration.cfm

Once you have complete the registration, you can access the DHS data and download the datasets you require. For calculating the FP source dataset, you will need to download the **individual recode** files in the **.dta format**. 

Below is an example of how you can begin with the raw DHS microdata .dta file and finish with an RDS file of FP source survey observations with uncertainty using the survey package from CRAN [1]. 

1. Load required libraries 
```{r, eval=FALSE}
library(survey) # Calculating the weighted proportions with uncertainty
library(dplyr) # Data manipulation
library(tidyr) # Data manipulation
library(haven) # Reading in DTA file into R 
library(xlsx) # Write to xlsx formats
library(labelled) # Reviewing labels within data
```


2. Set up folders for saving results and read in data. Begin extracting basic information from survey.
```{r, eval=FALSE}
folder <- "data/SEdata" # Set results folder
data <- haven::read_dta(file="data/dta_files/TEST.DTA") # Read in DTA file downloaded from DHS program data
year <-  min(data$v007) # Set the year of the survey
survey <- "DHS"
country_code <- unique(data$v000) # Unique country code identifier
```

3. Review and recode the contraceptive method names and supply sectors from their corresponding numerical codes to character entries.

```{r, eval=FALSE}
labelled::val_labels(data$v312) # Numerical codes and names of the contraceptive method used
data <- data %>% dplyr::mutate(modern_method_source= dplyr::case_when(v312==6 ~ "Sterilization (F)",
                                                        v312==7 ~ "Sterilization (M)",
                                                        v312==2 ~ "IUD",
                                                        v312==11 ~ "Implant",
                                                        v312==3 ~ "Injectable",
                                                        v312==1 ~ "OC Pills",
                                                        v312==5 ~ "Condom (M)",
                                                        v312==14 ~ "Condom (F)",
                                                        v312==4 | v312==15 | v312== 17 | v312== 18 | v312== 19 | v312== 20 ~ "Other Modern Methods",
                                                        v312==16 ~ "Emergency contraception",
                                                        v312==0 | v312==8 | v312==9 | v312==10 | v312==12 ~ "None"))


labelled::val_labels(data$v327) # Numerical codes and names of the contraceptive method supplier used
data <- data %>% dplyr::mutate(sector= dplyr::case_when(v327==1 | v327==2 ~ "Public",
                                          v327==3 ~ "NGO",
                                          v327==4 ~ "Private Clinic",
                                          v327==5 ~ "Pharmacy",
                                          v327==6 ~ "Shop Church Friend",
                                          v327==7 ~ "Other",
                                          v327==8 ~  NA_character_))

data <- data %>% dplyr::mutate(sector_categories= dplyr::case_when(v327==1 | v327==2 ~ "Public", # Further aggregate the sources into Public, private commercial medical and private other sectors
                                          v327==3 ~ "Commercial_medical",
                                          v327==4 ~ "Commercial_medical",
                                          v327==5 ~ "Commercial_medical",
                                          v327==6 ~ "Other",
                                          v327==7 ~ "Other",
                                          v327==8 ~  NA_character_))
```

```{r, eval=FALSE}
data$num <- 1
data$sampleweights <- data$v005/1000000 # As per the DHS data manual. This is the sample weights for each observation.

data <- data %>% dplyr::filter(is.na(sector_categories)==FALSE & modern_method_source %in% c("Implant", "Injectable", "OC Pills", "Sterilization (F)", "Sterilization (M)", "Condom (M)", "Condom (F)", "IUD","Other Modern Methods", "Emergency contraception"))

data %>% dplyr::count(sector) # count the number of observations in the sub-sectors
data %>% dplyr::count(sector_categories)  # count the number of observations in the sectors (public, commercial medical and other)
data %>% dplyr::count(modern_method_source)  # count the number of observations for each of the methods
counts <- data %>% dplyr::group_by(sector_categories) %>% dplyr::count(modern_method_source) %>% dplyr::rename(method = modern_method_source)

```

# Complex sample design parameters - including sample weights

```{r, eval=FALSE}
DHSdesign<- survey::svydesign(id=data$v021, strata=NULL, weights=data$sampleweights, data=data, nest=TRUE) # reflect the sample weights when calculating the observations. Some regions are densely populated and sampled, therefore these observations are down-weighted to allow for sparser regions.
options(survey.lonely.psu="adjust")
```


# Remove any stratum that only have one primary sampling unit (PSU)

```{r, eval=FALSE}
one_psu_strata <- data %>% dplyr::count(v023) %>% dplyr::filter(n == 1)
data <- data %>%
  dplyr::filter(!(v023 %in% one_psu_strata$v023))
```


# Calculate proprtions and standard errors for each of the three sectors, save the results to an excel file for each country

```{r, eval=FALSE}

n_methods <- c("Implant", "Injectable", "IUD", "Condom (M)", "Sterilization (F)", "OC Pills", "Emergency contraception", "Other Modern Methods")

my_SEdf_public <- data.frame()
  for(m in n_methods) {
    print(m)
    test_data <- data %>% dplyr::filter(sector_categories=="Public" & modern_method_source==m)
    if(nrow(test_data) != 0) {
      
      tmp <- as.data.frame(survey::svyby(~I(sector_categories=="Public"), ~I(modern_method_source==m), design=DHSdesign, svyciprop))
      
      my_tmpDF <- tibble(
        sector_categories="Public",
        method = m,
        proportion = tmp[2,2], # hardcode for now
        SE.proportion =  tmp[2,3]) 
      
      my_SEdf_public <- rbind(my_tmpDF, my_SEdf_public) 
    } else {
      next
    }
  }

my_SEdf_comm_med <- data.frame()
  for(m in n_methods) {
    print(m)
    test_data <- data %>% survey::svybyfilter(sector_categories=="Commercial_medical" & modern_method_source==m)
    if(nrow(test_data) != 0) { 
      tmp <- as.data.frame(survey::svyby(~I(sector_categories=="Commercial_medical"), ~I(modern_method_source==m), design=DHSdesign, svyciprop))
      my_tmpDF <- tibble(
        sector_categories="Commercial_medical",
        method = m,
        proportion = tmp[2,2], # hardcode for now
        SE.proportion =  tmp[2,3])
      
      my_SEdf_comm_med <- rbind(my_tmpDF, my_SEdf_comm_med)
      } else { 
      next
      }
  }

my_SEdf_other <- data.frame()
for(m in n_methods) {
  print(m)
  test_data <- data %>% filter(sector_categories=="Other" & modern_method_source==m)
  if(nrow(test_data) != 0) { 
    tmp <- as.data.frame(svyby(~I(sector_categories=="Other"), ~I(modern_method_source==m), design=DHSdesign, svyciprop))
    my_tmpDF <- tibble(
      sector_categories="Other",
      method = m,
      proportion = tmp[2,2], # hardcode for now
      SE.proportion =  tmp[2,3]) 
    
    my_SEdf_other <- rbind(my_tmpDF, my_SEdf_other)
  } else{ 
      next }
}

my_SEdf <- rbind(my_SEdf_comm_med, my_SEdf_other)
my_SEdf <- rbind(my_SEdf, my_SEdf_public) 
my_SEdf$country_code <- country_code
my_SEdf$year <- year
my_SEdf <- merge(my_SEdf, counts)

xlsx::write.xlsx(as.data.frame(my_SEdf), paste(folder, "/", country_code,"_", year, "_SEdf.xlsx" , sep=""))

```

## References
ICF. 2004-2017. Demographic and Health Surveys (various) [Datasets]. Funded by USAID. Rockville, Maryland: ICF [Distributor].

Elizabeth Heger Boyle, Miriam King and Matthew Sobek. IPUMS-Demographic and Health Surveys: Version 9 [dataset]. IPUMS and ICF, 2022. https://doi.org/10.18128/D080.V9

Lumley T (2020). “survey: analysis of complex survey samples.” R package version 4.0. 

